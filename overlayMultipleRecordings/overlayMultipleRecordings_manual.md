# Overlay Multiple Recordings Plugin

A FLIKA plugin for aligning, overlaying, and analyzing multiple PIEZO1 single-molecule localization microscopy (SMLM) recordings. This tool enables precise spatial alignment of different recordings from micropattern experiments and generates combined visualizations and statistical analyses of protein localization patterns.

## Overview

This plugin was developed to facilitate the analysis of PIEZO1 mechanosensitive ion channel localization across multiple experimental recordings. It works in conjunction with the `translateAndScale` plugin to create a complete workflow for multi-recording comparative analysis. The plugin allows researchers to:

- Overlay point localization data from multiple experiments
- Fine-tune alignment through interactive controls
- Generate density heatmaps based on point counts or tracked particle properties
- Compare spatial distributions across different experimental conditions

## Background

### PIEZO1 and Mechanobiology

PIEZO1 is a mechanosensitive ion channel that transduces mechanical forces into electrical and chemical signals. Understanding the spatial organization and distribution of PIEZO1 channels is crucial for elucidating mechanotransduction mechanisms. This plugin was specifically designed to analyze PIEZO1 localization patterns on micropattern geometries (disc, square, crossbow, Y-shape, H-shape) in human induced pluripotent stem cell (hiPSC)-derived cells.

### FLIKA Platform

FLIKA (Fluorescence Live Imaging ToolKit Analysis) is an open-source, Python-based image processing platform designed for biological fluorescence microscopy. It features a plugin architecture that allows researchers to extend its capabilities with specialized analysis tools like this one.

## Installation

### Prerequisites

- Python 3.7+
- FLIKA installed and functional
- Required Python packages:
  - numpy
  - pandas
  - scipy
  - scikit-image
  - matplotlib
  - pyqtgraph
  - qtpy
  - tqdm

### Installation Steps

1. **Copy plugin to FLIKA directory:**
```bash
cp -r overlayMultipleRecordings ~/.FLIKA/plugins/
```

2. **Restart FLIKA** or use the Plugin Manager to load the plugin

3. **Verify installation** by checking Plugins menu for "Overlay Multiple Recordings"

## Data Requirements

### Input File Format

The plugin expects CSV files with the following characteristics:

- **File naming:** Files must contain `_transform.csv` in their filename (generated by the `translateAndScale` plugin)
- **Required columns:**
  - `x_transformed` - transformed x coordinates (in pixels)
  - `y_transformed` - transformed y coordinates (in pixels)
- **Optional columns:**
  - `track_number` - track identifier for linked localizations
  - `Experiment` - experiment identifier for grouping
  - Any numerical column can be used for heatmap generation (e.g., `Rg` - radius of gyration)

### Typical Workflow Integration

1. Acquire TIRF microscopy time-lapse images of fluorescently-labeled PIEZO1
2. Perform single-molecule localization using tools like thunderSTORM
3. Track particles over time (generates `_tracksRG.csv` files)
4. Use `translateAndScale` plugin to align data to template patterns (generates `_transform.csv` files)
5. Use this plugin to overlay and analyze multiple aligned recordings

## Usage

### Starting the Plugin

```python
import flika
flika.start_flika()

# Open from menu
Plugins → Overlay Multiple Recordings
```

Or programmatically:
```python
from flika.plugins.overlayMultipleRecordings import OverlayMultipleRecordings
overlay = OverlayMultipleRecordings()
```

### Basic Workflow

#### Step 1: Prepare Base Image Window

1. Open a reference TIFF image in FLIKA (this serves as the base for plotting)
2. Select this window in the plugin's "Window" dropdown

#### Step 2: Load Data

1. Click "Select Folder" button
2. Navigate to folder containing `*_transform.csv` files
3. Plugin automatically loads all transform files from the folder
4. All data points are plotted on the image window:
   - **Green points**: All data from all files
   - **Red points**: Currently selected file (adjustable)

#### Step 3: Alignment Refinement

Use the Control Panel to fine-tune alignment of individual recordings:

**Movement Controls:**
- **Left/Right/Up/Down**: Translate selected data points
- **Counter/Clock**: Rotate selected data counterclockwise/clockwise
- **Save New Positions**: Export adjusted coordinates

**Parameters:**
- **Step size**: Translation distance in pixels (default: 1)
- **Multiply by**: Multiplier for step size
- **Rotation degrees**: Angle of rotation per button press (default: 1°)

**File Selection:**
- Use dropdown menu to select which file's data to manipulate
- Selected file's points appear in red for visual feedback

#### Step 4: Generate Heatmaps

##### Point Count Heatmap
1. Set "Heatmap Bins" value (typical: 50-200 bins)
2. Ensure "Use point values in heatmap" is **unchecked**
3. Click "Plot Heatmap"
4. Displays density map of point counts per spatial bin

##### Parameter-Based Heatmap
1. Check "Use point values in heatmap"
2. Select parameter from dropdown (e.g., "Rg", "x", "y")
3. Choose statistic: mean, median, max, or min
4. Optionally check "Bin by experiment" to average within experiments first
5. Click "Plot Heatmap"
6. Displays spatial distribution of selected parameter

#### Step 5: Center Data (Optional)

Check "Center data on image" to automatically center each dataset on the image window based on mean position.

## Key Functions

### Data Loading

```python
overlay.loadData()
```

Loads all `*_transform.csv` files from the selected folder. For each file:
- Reads CSV data
- Removes NaN and infinite values
- Separates tracked vs. untracked points (based on `track_number`)
- Optionally centers data on image
- Concatenates into master DataFrame

### Point Visualization

```python
# Plot all data points (green)
overlay.plotDataPoints()

# Plot selected file points (red)
overlay.plotSelectedDataPoints()
```

Uses PyQtGraph ScatterPlotItem for efficient rendering of large point datasets.

### Point Manipulation

```python
# Translate points
overlay.move(shiftValue, direction)  # direction: 'l', 'r', 'u', 'd'

# Rotate points around their centroid
overlay.rotatePoints(angle)  # angle in degrees
```

Transformations are applied to the selected file's data in the `x_transformed` and `y_transformed` columns.

### Heatmap Generation

The heatmap generation uses a two-step process:

1. **Binning**: Creates 2D spatial bins using `numpy.histogram2d`
2. **Statistics**: 
   - For point counts: simply counts points per bin
   - For parameters: groups by bin coordinates and calculates statistics

```python
# Generate heatmap
H, xedges, yedges = overlay.makeHeatmap()

# Display heatmap
overlay.plotHeatMap()
```

### Saving Transformations

```python
overlay.saveNewPositions()
```

Exports updated coordinates with suffix `_newPos_transform.csv`.

## Control Panel Interface

### Controls Dock
- **Navigation buttons**: Left, Right, Up, Down
- **Rotation buttons**: Counter (CCW), Clock (CW)
- **Save button**: Export adjusted positions

### Parameters Dock
- **Step size**: Fine-tune translation step
- **Multiply by**: Scale step size
- **Rotation degrees**: Set rotation increment

### File Dock
- **File selector**: Dropdown to choose active dataset

### Heatmap Dock
- **Use point values**: Toggle parameter-based heatmaps
- **Heatmap column**: Select data column for analysis
- **Statistic**: Choose aggregation method
- **Bin by experiment**: Group by experiment before binning
- **Heatmap Bins**: Set spatial resolution
- **Plot Heatmap button**: Generate visualization

## Advanced Features

### Multi-Recording Comparison

By overlaying multiple recordings, you can:

1. **Identify consistent patterns**: Areas with consistently high/low PIEZO1 density across recordings
2. **Detect variability**: Regions where localization varies between experiments
3. **Statistical analysis**: Generate mean/median heatmaps across recordings
4. **Quality control**: Visually inspect alignment quality

### Experimental Grouping

The plugin supports experiment-level binning:

```python
# Enable in GUI: check "Bin by experiment" checkbox
```

This first groups points by experiment identifier, calculates statistics within each experiment, then bins spatially. Useful for:
- Technical replicates
- Biological replicates
- Different experimental conditions

### Custom Parameter Analysis

Any numerical column in the CSV can be analyzed:

- **Rg** (radius of gyration): Measure of trajectory confinement
- **track_length**: Duration of observed track
- **x, y**: Raw coordinates
- **Custom parameters**: From your analysis pipeline

## Output Files

### Transformed Coordinates

When "Save New Positions" is clicked:

```
filename_newPos_transform.csv
```

Contains all original columns plus updated `x_transformed` and `y_transformed` coordinates.

### Heatmap Windows

Heatmaps are displayed as new FLIKA windows with descriptive titles:
- Point count heatmaps: `"point count"`
- Parameter heatmaps: `"{parameter} : {statistic}"` (e.g., "Rg : mean")
- Experiment-binned: `"{parameter} : {statistic} (binned by experiment)"`

## Practical Tips

### Alignment Strategy

1. **Start coarse**: Use large step sizes (10-50 pixels) for initial positioning
2. **Refine incrementally**: Decrease step size as alignment improves
3. **Use rotation sparingly**: Small angle adjustments (1-5°) usually sufficient
4. **Visual verification**: Compare red (selected) points against green (all) points
5. **Save frequently**: Export intermediate alignments to preserve work

### Heatmap Best Practices

1. **Bin size selection**:
   - Small bins (200+): High resolution but noisy if data is sparse
   - Large bins (20-50): Smooth but may miss fine details
   - Typical range: 50-100 bins for most datasets

2. **Parameter selection**:
   - **Rg**: Reveals regions of confined vs. mobile particles
   - **track_length**: Shows areas with stable vs. transient localization
   - **Intensity**: Identifies high vs. low expression regions

3. **Statistic choice**:
   - **Mean**: General tendency, affected by outliers
   - **Median**: Robust to outliers, represents typical value
   - **Max**: Highlights extreme values
   - **Min**: Shows baseline or background levels

### Performance Optimization

For very large datasets (>100,000 points):

1. **Reduce visualization points**: Work with subsampled data for alignment
2. **Increase bin size**: Use fewer bins (50-75) for faster heatmap generation
3. **Process subsets**: Analyze data in groups rather than all at once
4. **Memory management**: Close unused windows to free memory

## Troubleshooting

### Common Issues

**Problem**: Points appear far outside image
- **Cause**: Data not properly centered or scaled by `translateAndScale` plugin
- **Solution**: Re-run `translateAndScale` with correct parameters

**Problem**: No points visible after loading
- **Cause**: Data coordinates may be in different units than image
- **Solution**: Check `x_transformed` and `y_transformed` ranges match image dimensions

**Problem**: Heatmap appears blank
- **Cause**: Insufficient data in spatial bins or all values are identical
- **Solution**: 
  - Reduce bin count
  - Check data loaded correctly
  - Verify parameter column contains numeric values

**Problem**: "Can only generate heat maps from numeric data" error
- **Cause**: Selected heatmap column contains non-numeric values (e.g., strings)
- **Solution**: Select a different column with numeric data

**Problem**: Plugin crashes with large files
- **Cause**: Insufficient memory
- **Solution**:
  - Work with fewer files simultaneously
  - Increase system RAM
  - Use subsampled data for initial alignment

### File Format Issues

If CSV loading fails, verify:
- Files are properly formatted CSV (comma-separated)
- No special characters in column names
- `x_transformed` and `y_transformed` columns exist
- No completely empty rows

## Detailed Examples

### Example 1: Basic Overlay and Heatmap

```python
# 1. Start FLIKA and load base image
import flika
flika.start_flika()
base_img = flika.open_file('reference.tif')

# 2. Initialize plugin
from flika.plugins.overlayMultipleRecordings import overlayMultipleRecordings

# 3. Select base image window in GUI
# 4. Click "Select Folder" and choose folder with transform files
# 5. Data loads automatically - green points appear

# 6. Generate point count heatmap
# - Set "Heatmap Bins" to 100
# - Uncheck "Use point values in heatmap"
# - Click "Plot Heatmap"
```

### Example 2: Rg (Mobility) Analysis

```python
# After loading data (as above)...

# Generate heatmap showing mean radius of gyration
# 1. Check "Use point values in heatmap"
# 2. Select "Rg" from "Heatmap value" dropdown
# 3. Select "mean" from "stat" dropdown
# 4. Set bins to 75
# 5. Click "Plot Heatmap"

# Result: Shows spatial distribution of particle mobility
# - Dark regions: Low Rg (confined particles)
# - Bright regions: High Rg (mobile particles)
```

### Example 3: Manual Alignment Refinement

```python
# After loading data...

# 1. Select file from dropdown that needs alignment
# - Red points show selected file
# - Green points show all other data

# 2. Rough alignment
# - Set "Step size" = 50, "Multiply by" = 1
# - Use arrow buttons to position data

# 3. Fine alignment
# - Set "Step size" = 1, "Multiply by" = 1
# - Use arrow buttons for precise positioning

# 4. Rotation adjustment (if needed)
# - Set "Rotation degrees" = 2
# - Click "Counter" or "Clock" buttons

# 5. Save adjusted positions
# - Click "Save New Positions"
# - File saved with "_newPos_transform.csv" suffix
```

### Example 4: Comparing Different Experimental Conditions

```python
# Folder structure:
# /data/control/
#   - cell1_tracksRG_transform.csv
#   - cell2_tracksRG_transform.csv
# /data/treated/
#   - cell1_tracksRG_transform.csv
#   - cell2_tracksRG_transform.csv

# Analysis:
# 1. Load control data folder
# 2. Generate mean Rg heatmap → Save as "control_Rg_heatmap.tif"
# 3. Close plugin
# 4. Load treated data folder
# 5. Generate mean Rg heatmap → Save as "treated_Rg_heatmap.tif"
# 6. Compare heatmaps in external software
```

## Technical Details

### Coordinate System

- **Origin**: Top-left corner of image (FLIKA convention)
- **Units**: Pixels
- **Transformation**: Applied to `x_transformed` and `y_transformed` columns
- **Rotation**: About centroid of selected dataset

### Data Structure

Internal data stored as pandas DataFrame:

| Column | Type | Description |
|--------|------|-------------|
| x_transformed | float | Transformed x coordinate |
| y_transformed | float | Transformed y coordinate |
| track_number | int/NaN | Particle track identifier |
| file | str | Source filename |
| bin_x | int | X bin assignment (heatmap) |
| bin_y | int | Y bin assignment (heatmap) |
| ... | various | Original CSV columns |

### Algorithms

**Rotation:**
```python
def rotate_around_point(x, y, angle, origin=(0,0)):
    radians = angle * math.pi / 180
    offset_x, offset_y = origin
    adjusted_x = (x - offset_x)
    adjusted_y = (y - offset_y)
    cos_rad = math.cos(radians)
    sin_rad = math.sin(radians)
    dx = offset_x + cos_rad * adjusted_x + sin_rad * adjusted_y
    dy = offset_y + -sin_rad * adjusted_x + cos_rad * adjusted_y
    return dx, dy
```

**Binning:**
```python
# 2D histogram for spatial binning
H, xedges, yedges = np.histogram2d(x_transformed, y_transformed, bins=n_bins)

# Assign bin indices to each point
data['bin_x'] = np.digitize(x_transformed, xedges) - 1
data['bin_y'] = np.digitize(y_transformed, yedges) - 1

# Group and aggregate
grouped = data.groupby(['bin_x', 'bin_y'])
stats = grouped[parameter].mean()  # or median, max, min
```

## Related Plugins

### translateAndScale

**Purpose**: Aligns individual recordings to standardized micropattern templates

**Workflow**: Use before overlayMultipleRecordings

**Output**: `*_transform.csv` files (input for this plugin)

### ThunderSTORM

**Purpose**: Single-molecule localization from raw microscopy images

**Workflow**: Use before translateAndScale

**Output**: `*_locs.csv` files

## Development and Customization

### Adding New Features

The plugin structure allows easy extension:

```python
class OverlayMultipleRecordings(BaseProcess_noPriorWindow):
    def __init__(self):
        # Add new GUI items to __init__
        super().__init__()
        
    def custom_analysis(self):
        # Add custom analysis methods
        pass
```

### Modifying Heatmap Statistics

To add new statistics:

1. Locate `makeHeatmap()` method
2. Add elif clause for new statistic:
```python
elif stat == 'custom':
    mapDF = groupedDF[self.heatmapValue].apply(custom_function)
```
3. Add option to statBox in ControlPanel `__init__`

## Citation

When using this plugin, please cite:

```
Bertaccini, G. A., Casanellas, I., Evans, E. L., Nourse, J. L., Dickinson, G. D., 
Liu, G., Seal, S., Ly, A. T., Holt, J. R., Wijerathne, T. D., Yan, S., Hui, E. E., 
Lacroix, J. J., Panicker, M. M., Upadhyayula, S., Parker, I., & Pathak, M. M. (2025). 
Visualizing PIEZO1 localization and activity in hiPSC-derived single cells and organoids 
with HaloTag technology. Nature Communications, 16(1), 5556. 
https://doi.org/10.1038/s41467-025-59150-1
```

Original bioRxiv preprint:
```
Bertaccini, G. A. et al. (2023). PIEZO1-HaloTag hiPSCs: Bridging Molecular, Cellular 
and Tissue Imaging. bioRxiv, 2023.12.22.573117. 
https://doi.org/10.1101/2023.12.22.573117
```

## Contributing

To contribute to this plugin:

1. Fork the repository
2. Create a feature branch
3. Test thoroughly with various datasets
4. Submit a pull request with detailed description

## Support and Contact

For assistance with the plugin:

- **GitHub Issues**: Report bugs or request features
- **FLIKA Documentation**: https://flika-org.github.io/
- **Contact**: George Dickinson (george.dickinson@gmail.com)
- **Lab Website**: Pathak Lab, UC Irvine

## License

MIT License - See LICENSE file for details

## Acknowledgments

Developed by George Dickinson for the Pathak Laboratory at UC Irvine. This work was supported by research into PIEZO1 mechanotransduction using human induced pluripotent stem cells.

## Version History

- **v1.0** (2024): Initial release with basic overlay and heatmap functionality
- **v1.1** (2024): Added parameter-based heatmaps, experimental binning
- **v1.2** (2024): Performance improvements for large datasets

## Appendix: Parameter Definitions

### Common Track Parameters

- **Rg (radius of gyration)**: Square root of mean squared displacement from track centroid; indicates degree of confinement
- **track_length**: Number of frames particle was tracked
- **x, y**: Spatial coordinates
- **intensity**: Fluorescence intensity (if available)
- **sigma**: Localization precision estimate

### Micropattern Geometries

- **Disc**: Circular pattern
- **Square**: Square grid pattern
- **Crossbow**: Asymmetric crossbow shape
- **Y-shape**: Three-armed Y pattern
- **H-shape**: H-shaped pattern

These patterns are used to constrain cell growth and study how geometry affects PIEZO1 localization and mechanotransduction.